<!DOCTYPE html>
<html>
  <head>
  <title>Junk Drawer : Making mass-edits to many repos via shell pipelines</title>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  <!-- link to main stylesheet -->
  <link rel="stylesheet" type="text/css" href="https://benknoble.github.io/assets/css/styles.css" media="screen">

  <script src="/assets/js/scale.fix.js"></script>
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" >
  </script>

  <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/assets/img/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link type="application/atom+xml" rel="alternate" href="https://benknoble.github.io/feed.xml" title="Junk Drawer" />
</head>

  <body>
    <header>
  <h1>
  <a href="https://benknoble.github.io/">
  <img src="/assets/img/logo.png" alt="Junk Drawer Logo" width="32" height="32"> Junk Drawer</a>
</h1>
  <p>For all those little papers scattered across your desk</p>
</header>

    <section>
      <nav>
  <ul>
    
    <li class="">
      <a href="https://benknoble.github.io/about/">About</a>
    </li>
    
    <li class="">
      <a href="https://benknoble.github.io/categories/">Posts</a>
    </li>
    
    <li class="">
      <a href="https://benknoble.github.io/workshops/">Workshops</a>
    </li>
    
    <li class="">
      <a href="https://benknoble.github.io/papers/">Papers</a>
    </li>
    
    <li class="">
      <a href="https://benknoble.github.io/writings/">Writings</a>
    </li>
    
    <li class="">
      <a href="https://benknoble.github.io/reading/">Reading List</a>
    </li>
    
  </ul>
</nav>

      <h1>Making mass-edits to many repos via shell pipelines</h1>
      <p class="meta"><span class="authors">
  
  
    D. Ben Knoble
  
</span>
 on 16 Jul 2020 in Blog</p>
<div id="post">
  <p>I spend 1 day to save 3 immediately, and more long-term, by scripting git into
pipelines.</p>

<h2 id="prelude">Prelude</h2>

<p>Imagine you have a task before you that requires you to update 15 or so
repositories on GitHub with the same or similar one-line changes in several
different files. How do you solve it?</p>

<p>In my case, I had a list of 16 repository URLs in the file <code class="language-plaintext highlighter-rouge">URLs</code>; I collected
these after figuring out which YAML variables to correct in order to fix an
installation problem with a part of our infrastructure. And I knew I could clone
them all, fork them, do the changes, and open the pull-requests, but it would
take forever! Too many manual steps.</p>

<p>So I got clever.</p>

<blockquote>
  <p>If you aren’t sure how <code class="language-plaintext highlighter-rouge">xargs</code> works, you will be by the end of this post:
<code class="language-plaintext highlighter-rouge">xargs</code> is a filter that takes its standard in and uses it as arguments for
another command. In essence, it can replace <code class="language-plaintext highlighter-rouge">while read</code> loops, when used
right.</p>
</blockquote>

<h2 id="kitchen-cutleryor-ratherforks">Kitchen Cutlery—or rather—Forks</h2>

<p>My first step was to figure out how to fork all those repos! I knew about <code class="language-plaintext highlighter-rouge">hub
fork</code>, but it only works from inside an already cloned repo. Then there’s the
new GitHub CLI <code class="language-plaintext highlighter-rouge">gh repo fork</code>, but it doesn’t support enterprise GitHub yet.
Darn!</p>

<p>I really wanted to do this separately, so I <a href="https://github.com/benknoble/Dotfiles/blob/master/links/bin/git-fork-repo">whipped up a forking
script</a>.
In the process, I had to learn how to use the GitHub API and <a href="https://github.com/github/hub/issues/2576">workaround a bug
in hub’s <code class="language-plaintext highlighter-rouge">api</code> command on enterprise
hosts</a>. The script outputs the URL of
the fork for downstream consumption (e.g., <code class="language-plaintext highlighter-rouge">open</code> on a Mac).</p>

<p>After testing the script, I was ready to create all the forks!</p>

<p>Well, not exactly. I designed the script to take parameters <code class="language-plaintext highlighter-rouge">owner repo</code>, not
URL… it is specific to GitHub, after all. So I needed to transform the URLs. I
probably could have done a combination of <code class="language-plaintext highlighter-rouge">basename</code> and <code class="language-plaintext highlighter-rouge">dirname</code>, but for this
task I wrote an <code class="language-plaintext highlighter-rouge">awk</code> script:</p>

<div class="language-awk highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#! /usr/bin/env awk -f</span>
<span class="c1"># mk-forkable.awk</span>

<span class="kr">BEGIN</span> <span class="p">{</span> <span class="kc">FS</span><span class="o">=</span><span class="s2">"/"</span> <span class="p">}</span>
<span class="p">{</span> <span class="k">print</span> <span class="nv">$4</span><span class="p">,</span> <span class="nv">$5</span> <span class="p">}</span>
</code></pre></div></div>

<p>This enabled step one, forking:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;URLs ./mk-forkable.awk | xargs <span class="nt">-L1</span> git fork-repo <span class="o">&gt;</span>forks
</code></pre></div></div>

<p>This gives me a list of fork URLs in <code class="language-plaintext highlighter-rouge">forks</code> and creates the forks on GitHub.</p>

<h2 id="mass-changes">Mass changes</h2>

<p>And no, I’m not talking about <em>weight</em> changes—I mean being able to make
changes to all the repos! What I really wanted, I realized, was the ability to
pipe in the list of repositories to a script that would clone them, make the
changes on a new branch, push that branch, and spit out the repository URL again
so I could open it up.</p>

<p>Thus, <a href="https://github.com/benknoble/Dotfiles/blob/master/links/bin/git-mass-edit"><code class="language-plaintext highlighter-rouge">git-mass-edit</code> was
born</a>.
The usage really sums up the intended use- and design-case:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>usage: $0 [-b &lt;branch-name&gt;] [-m &lt;message&gt;] [-r &lt;remote-name&gt;] &lt;edit-command&gt; &lt;repo&gt;
Executes the following steps:
  - If &lt;repo&gt; doesn't exist, clones it
  - Creates a new branch named &lt;branch-name&gt;
  - Runs &lt;edit-command&gt; inside the repo
  - Commits using &lt;message&gt;
  - Pushes to &lt;branch-name&gt; on &lt;remote-name&gt;
  - Outputs &lt;repo&gt;
Default values:
  &lt;branch-name&gt;  mass-edit
  &lt;message&gt;      mass-edit
  &lt;remote-name&gt;  origin
Designed to be attached to xargs(1) and an input stream of repos to mass-edit.
For example, if you have a list of github URLs you want to edit the same way and
then open up in a browser:
&lt;URLs xargs -n1 [-P...] git-mass-edit [...] edit-command | xargs open
</code></pre></div></div>

<p>All that was left was to build an editing script, which mostly delegates to a
silenced and nerfed vim, which uses <code class="language-plaintext highlighter-rouge">git-grep</code> to build a list of lines to
change and then changes them with <code class="language-plaintext highlighter-rouge">cdo</code> and <code class="language-plaintext highlighter-rouge">substitute</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#! /usr/bin/env bash</span>
<span class="c"># fix-yaml-var</span>

<span class="nb">set</span> <span class="nt">-euo</span> pipefail

log<span class="o">()</span> <span class="o">{</span>
  <span class="nb">printf</span> <span class="s1">'%s\n'</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
<span class="o">}</span> <span class="o">&gt;</span>&amp;2

die<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">ex</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">exit</span> <span class="s2">"</span><span class="nv">$ex</span><span class="s2">"</span>
<span class="o">}</span>

main<span class="o">()</span> <span class="o">{</span>
  git config user.name <span class="s1">'David Knoble'</span>
  git config user.email <span class="s1">'david.knoble@WORK'</span>
  <span class="nb">local </span><span class="nv">oldkey</span><span class="o">=</span>old_key
  <span class="nb">local </span><span class="nv">newkey</span><span class="o">=</span>new_key
  <span class="nb">local </span><span class="nv">skip</span><span class="o">=</span>does-not-exist
  <span class="nb">local </span><span class="nv">newval</span><span class="o">=</span>our-new-val
  vim <span class="nt">-es</span> <span class="nt">-N</span> <span class="nt">-u</span> NONE <span class="nt">-i</span> NONE <span class="nt">-S</span> &lt;<span class="o">(</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">DOG</span><span class="sh">
  set hidden
  if !exists(':Cfilter') | packadd cfilter | endif
  let &amp;grepprg = 'git grep -n'
  silent! grep </span><span class="nv">$oldkey</span><span class="sh">
  silent! cdo substitute/</span><span class="nv">$oldkey</span><span class="sh">/</span><span class="nv">$newkey</span><span class="sh">/g
  Cfilter! /</span><span class="nv">$skip</span><span class="sh">/
  Cfilter /</span><span class="nv">$oldkey</span><span class="sh">:/
  silent! cdo substitute^:.*^: </span><span class="nv">$newval</span><span class="sh">^
  wall
  quit
</span><span class="no">DOG
</span><span class="o">)</span>
<span class="o">}</span>

main <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div></div>

<p>Finally, I launched the script!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;forks xargs <span class="nt">-n1</span> <span class="nt">-P8</span>  git-mass-edit <span class="nt">-b</span> fix-yaml-var <span class="nt">-m</span> <span class="s1">'some message'</span> <span class="si">$(</span><span class="nb">realpath</span> ./fix-yaml-var<span class="si">)</span> | xargs <span class="nt">-L1</span>  open
</code></pre></div></div>

<p>From here, I did the (very manual) process of opening all the PRs. If I had
been a bit smarter, I would have you used <code class="language-plaintext highlighter-rouge">hub pull-request</code> with <code class="language-plaintext highlighter-rouge">-F</code> to do
these, but this might have required additional setup.</p>

<h2 id="but-wait-theres-more">But wait, there’s more!</h2>

<p>I wanted to collect a list of PRs without trying to web-scrape them off my PRs
page. I had the repos, and <code class="language-plaintext highlighter-rouge">hub</code>’s command <code class="language-plaintext highlighter-rouge">pr</code> can show the URL. I needed to
do some setup, though, because <code class="language-plaintext highlighter-rouge">hub pr</code> only works when the remote is the
upstream repository!</p>

<p>First, move the old repos out of the way:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;forks xargs <span class="nb">basename</span> | xargs <span class="nt">-n1</span> bash <span class="nt">-c</span> <span class="s1">'mv "$1" benknoble-"$1"'</span> sh
</code></pre></div></div>

<p>(Thank goodness <code class="language-plaintext highlighter-rouge">basename</code> works on URLs! Coincidence?)</p>

<p>Next, clone the proper repositories:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;URLs xargs <span class="nt">-L1</span> <span class="nt">-P</span><span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> &lt;URLS<span class="si">)</span> git clone <span class="nt">--quiet</span>
</code></pre></div></div>

<p>In parallel, this goes pretty quickly.</p>

<p>Lastly, grab the URLs. Oh, wait, I had to script that too:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#! /bin/sh</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> hub <span class="nb">pr </span>show <span class="nt">-u</span> <span class="s2">"</span><span class="si">$(</span>hub <span class="nb">pr </span>list | <span class="nb">grep</span> <span class="s1">'the PR title'</span> | fields 1 | <span class="nb">cut</span> <span class="nt">-c2-3</span><span class="si">)</span><span class="s2">"</span>
</code></pre></div></div>

<p>Looking back on it, this only works for 2-digit PR numbers <img class="emoji" title=":thinking:" alt=":thinking:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png" height="20" width="20"></p>

<p>OK, let’s actually grab those PR numbers:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;URLs xargs <span class="nt">-L1</span> <span class="nb">basename</span> | xargs <span class="nt">-L1</span> <span class="nt">-P</span><span class="si">$(</span><span class="nb">wc</span> <span class="nt">-l</span> &lt;URLs<span class="si">)</span> ./get-pr-url <span class="o">&gt;</span>prs
</code></pre></div></div>

<h2 id="addendum">Addendum</h2>

<p>I later had to make some quick fixes, which I did with slightly less up-front
automation work. I had to grab the fixes to be made from PR branches, but
actually make them in the upstream repos in order to pull in the merged changes.
So the first bit was to grab all the right spots and dumps them to the file
fixes:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;URLs xargs <span class="nb">basename</span> | xargs <span class="nt">-n1</span> bash <span class="nt">-c</span> <span class="s1">'git -C benknoble-"$1" grep newkey | xargs -L1 echo "$1/"'</span> sh | <span class="nb">grep</span> <span class="nt">-w</span> thing | <span class="nb">sed</span> <span class="s1">'s/ //'</span> <span class="o">&gt;</span>fixes
</code></pre></div></div>

<p>Note the nested <code class="language-plaintext highlighter-rouge">xargs</code> to process the grep results and prepend the repository
name!</p>

<p>I loaded this in vim with the <code class="language-plaintext highlighter-rouge">-q</code> flag for the quickfix list and made the edit:</p>

<div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">" vim -q fixes</span>
<span class="p">:</span><span class="k">cdo</span> s<span class="sr">/newkey: \zs.*/</span>fixed<span class="p">-</span>value
<span class="p">:</span><span class="k">wall</span> <span class="p">|</span> <span class="k">q</span>
</code></pre></div></div>

<p>Then I created a list of repos that needed the fixes using <a href="/blog/2019/09/11/fields/">my old fields
script</a>, and used that to create the
commits. A push to the PR branch and I was good to go.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;fixes fields <span class="nt">-f</span>: 1 | fields <span class="nt">-f</span>/ 1 | <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> fixed-repos
&lt;fixed-repos xargs <span class="nt">-L1</span> bash <span class="nt">-c</span> <span class="s1">'cd "$1" &amp;&amp; git add . &amp;&amp; git commit -m "fix the thing"'</span> sh
</code></pre></div></div>

</div>
<hr>
<h4>Tags:</h4>
<ul class="tags">
  
    <li>
      <a href="https://benknoble.github.io/tags#dotfiles" class="tag">
        dotfiles
      </a>
    </li>
  
    <li>
      <a href="https://benknoble.github.io/tags#git" class="tag">
        git
      </a>
    </li>
  
    <li>
      <a href="https://benknoble.github.io/tags#github" class="tag">
        github
      </a>
    </li>
  
    <li>
      <a href="https://benknoble.github.io/tags#github-workflow" class="tag">
        github-workflow
      </a>
    </li>
  
    <li>
      <a href="https://benknoble.github.io/tags#json" class="tag">
        json
      </a>
    </li>
  
    <li>
      <a href="https://benknoble.github.io/tags#productivity" class="tag">
        productivity
      </a>
    </li>
  
    <li>
      <a href="https://benknoble.github.io/tags#project-management" class="tag">
        project-management
      </a>
    </li>
  
    <li>
      <a href="https://benknoble.github.io/tags#shell" class="tag">
        shell
      </a>
    </li>
  
</ul>

<div id="post-categories">
  <h4>Categories:
  
    <a href="/categories/#blog">Blog</a>
    
  
  </h4>
</div>

<div id="disqus_thread"></div>
<div class="load-comments" onclick="load_comments(this)">Load Comments</div>
<script>
  var disqus_shortname = 'https-benknoble-github-io';
  var disqus_config = function () {
    this.page.url = "https://benknoble.github.io/blog/2020/07/16/parallel-git-pipelines/";
    this.page.identifier = "/blog/2020/07/16/parallel-git-pipelines";
  };

  function load_comments(div) {
    var d = document, s = d.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    div.parentNode.removeChild(div)
  };
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>


<div id="post-navigation">
  
  <span id="previous">
    <a href="https://benknoble.github.io/blog/2020/06/22/logic-puzzle-race/" title="Solving a logic puzzle the right way™">
      Previous</a>
  </span>
  
  
  <span id="next">
    <a href="https://benknoble.github.io/blog/2020/08/06/stop-sed-i/" title="Stop, sed i!">
      Next</a>
  </span>
  
</div>
<div id="back-to-posts">
  <a href="/categories/#making-mass-edits-to-many-repos-via-shell-pipelines">
    Back to posts</a>
</div>

    </section>
    <footer>
<hr>
  <ul>
    
    <li>
      <a href="https://benknoble.github.io/">Home</a>
    </li>
    
    <li>
      <a href="https://benknoble.github.io/contact/">Contact</a>
    </li>
    
    <li>
      <a href="https://benknoble.github.io/sitemap.xml">Sitemap</a>
    </li>
    
    <li>
      <a href="https://benknoble.github.io/feed.xml">RSS Feed</a>
    </li>
    
    <li>
      <a href="https://benknoble.github.io/colophon/">Colophon</a>
    </li>
    
    <li>
      <a href="https://github.com/benknoble/benknoble.github.io/blob/master/LICENSE">Copyright D. Ben Knoble <script type="text/javascript">document.write(new Date().getFullYear())</script></a>
    </li>
    
    <li>
      <p xmlns:cc="http://creativecommons.org/ns#"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-NC-SA 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" alt=""></a></p>
    </li>
  </ul>
</footer>

    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    <script>
      (function() {
        var script = document.createElement('script');
        window.counter = 'https://benknoble_github_io.goatcounter.com/count'
        script.async = 1;
        script.src = '//gc.zgo.at/count.js';

        var ins = document.getElementsByTagName('script')[0];
        ins.parentNode.insertBefore(script, ins)
      })();
    </script>
  </body>
</html>
